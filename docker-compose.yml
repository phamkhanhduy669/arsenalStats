services:
  # 0. Zookeeper (required for Kafka in ZK mode)
  zookeeper:
    image: confluentinc/cp-zookeeper:7.7.7
    container_name: zookeeper
    environment:
      - ZOOKEEPER_CLIENT_PORT=2181
      - ZOOKEEPER_TICK_TIME=2000
    ports:
      - "2181:2181"
    networks:
      - arsenal-net

  # 0. Kafka
  kafka:
    image: confluentinc/cp-kafka:7.7.7
    container_name: kafka
    depends_on:
      - zookeeper
    environment:
      - KAFKA_BROKER_ID=1
      - KAFKA_ZOOKEEPER_CONNECT=zookeeper:2181
      - KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092
      - KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://kafka:9092
      - KAFKA_LISTENER_SECURITY_PROTOCOL_MAP=PLAINTEXT:PLAINTEXT
      - KAFKA_INTER_BROKER_LISTENER_NAME=PLAINTEXT
      - KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=1
      - KAFKA_TRANSACTION_STATE_LOG_MIN_ISR=1
      - KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS=0
    ports:
      - "9092:9092"
    networks:
      - arsenal-net

  # 0. Postgres (for batching ETL)
  postgres:
    image: postgres:15
    container_name: postgres
    environment:
      - POSTGRES_DB=project_1
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./postgesql/create_table.sql:/docker-entrypoint-initdb.d/01-create_table.sql
      - ./postgesql/trigger.sql:/docker-entrypoint-initdb.d/02-trigger.sql
    networks:
      - arsenal-net

  # 1. Flink JobManager
  jobmanager:
    build:
      context: .
      dockerfile: streaming/container/flink/DockerFile
    image: arsenal-flink:local
    container_name: jobmanager
    ports:
      - "8081:8081"
    command: jobmanager
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: jobmanager
    networks:
      - arsenal-net

  # 2. Flink TaskManager
  taskmanager:
    build:
      context: .
      dockerfile: streaming/container/flink/DockerFile
    image: arsenal-flink:local
    depends_on:
      - jobmanager
    command: taskmanager
    scale: 1
    environment:
      - |
        FLINK_PROPERTIES=
        jobmanager.rpc.address: jobmanager
        taskmanager.numberOfTaskSlots: 2
    networks:
      - arsenal-net

  # 2.1. Flink Job Auto-Submitter (PyFlink)
  flink-job-submitter:
    image: arsenal-flink:local
    container_name: flink-job-submitter
    depends_on:
      - jobmanager
      - taskmanager
      - kafka
      - postgres
    command:
      [
        "bash",
        "-c",
        "sleep 15 && python /opt/flink/usrlib/code/match_stream.py",
      ]
    networks:
      - arsenal-net
    restart: "no"

  # 3. Streaming Producer
  producer:
    build:
      context: .
      dockerfile: streaming/code/producer/DockerFile
    image: arsenal-producer:local
    container_name: producer_app
    environment:
      - KAFKA_BOOTSTRAP_SERVER=kafka:9092
      - RAPIDAPI_KEY=${RAPIDAPI_KEY}
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=project_1
      - DB_USER=postgres
      - DB_PASSWORD=postgres
    depends_on:
      - kafka
      - postgres
    networks:
      - arsenal-net

  # 4. Batching ETL
  batching_etl:
    build:
      context: .
      dockerfile: batching/container/pipelinerunner/DockerFile
    image: arsenal-batching:local
    container_name: batching_etl
    environment:
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=project_1
      - DB_USER=postgres
      - DB_PASSWORD=postgres
      - RAPIDAPI_KEY=${RAPIDAPI_KEY}
      - TZ=Asia/Ho_Chi_Minh
    depends_on:
      - postgres
    networks:
      - arsenal-net

networks:
  arsenal-net:
    driver: bridge

volumes:
  postgres-data:
