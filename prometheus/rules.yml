groups:
  - name: kafka
    rules:
      - alert: KafkaBrokerDown
        expr: up{job="kafka"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Kafka broker DOWN"
          description: "Kafka broker {{ $labels.instance }} has not responded for more than 1 minute."

      - alert: KafkaConsumerLagHigh
        expr: kafka_consumer_group_lag{job="kafka"} > 5000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Kafka consumer lag is high"
          description: "Consumer group {{ $labels.consumergroup }} for topic {{ $labels.topic }} is lagging by {{ $value }} messages."

      - alert: KafkaUnderReplicatedPartitions
        expr: kafka_server_replicamanager_underreplicatedpartitions > 0
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Kafka partition is under-replicated"
          description: "There are {{ $value }} partitions that are under-replicated."

      - alert: KafkaOfflinePartitions
        expr: kafka_controller_kafkacontroller_offlinepartitionscount > 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Kafka partition offline"
          description: "There are {{ $value }} partitions currently offline."

      - alert: KafkaDiskUsageHigh
        expr: (kafka_log_size / kafka_log_size_limit) * 100 > 80
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Kafka high disk usage"
          description: "Kafka is using more than 80% of disk capacity."

  - name: zookeeper
    rules:
      - alert: ZookeeperDown
        expr: up{job="zookeeper"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Zookeeper DOWN"
          description: "Zookeeper {{ $labels.instance }} is not responding."

      - alert: ZookeeperOutstandingRequests
        expr: zookeeper_outstanding_requests > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Zookeeper has too many outstanding requests"
          description: "Zookeeper currently has {{ $value }} outstanding requests."

  - name: flink
    rules:
      - alert: FlinkJobManagerDown
        expr: up{job="flink"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Flink JobManager DOWN"
          description: "Flink JobManager has not responded for more than 1 minute."

      - alert: FlinkJobFailed
        expr: flink_jobmanager_job_numrestarts > 3
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Flink job is restarting repeatedly"
          description: "Job {{ $labels.job_name }} has restarted {{ $value }} times."

      - alert: FlinkCheckpointFailed
        expr: flink_jobmanager_job_lastCheckpointRestoreTimestamp == -1
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Flink checkpoint failed"
          description: "Job {{ $labels.job_name }} has no successful checkpoint."

      - alert: FlinkCheckpointDurationHigh
        expr: flink_jobmanager_job_lastCheckpointDuration > 30000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Flink checkpoint duration is too high"
          description: "Checkpoint duration is {{ $value }}ms (threshold: 30s)."

      - alert: FlinkTaskManagerDown
        expr: flink_jobmanager_numRegisteredTaskManagers < 1
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "No Flink TaskManager is running"
          description: "Number of registered TaskManagers: {{ $value }}."

  - name: postgres
    rules:
      - alert: PostgresDown
        expr: up{job="postgres"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Postgres DOWN"
          description: "Postgres exporter is not responding."

      - alert: PostgresConnectionsHigh
        expr: pg_stat_activity_count > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Postgres connections are high"
          description: "Current number of connections: {{ $value }}."

      - alert: PostgresDiskUsageHigh
        expr: pg_database_size_bytes{datname="project_1"} > 4 * 1024 * 1024 * 1024
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Postgres DB is nearly full"
          description: "Database project_1 is using {{ $value | humanize1024 }}B (threshold: 4GiB)."

      - alert: PostgresDeadlocksHigh
        expr: rate(pg_stat_database_deadlocks{datname="project_1"}[5m]) > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Postgres deadlock detected"
          description: "A deadlock was detected in database project_1."

      - alert: PostgresSlowQueries
        expr: pg_stat_activity_max_tx_duration{datname="project_1"} > 300
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Postgres has long-running queries"
          description: "A query has been running for more than {{ $value }}s."
